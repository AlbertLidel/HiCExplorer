<tool id="hicexplorer_hicplottads" name="@BINARY@" version="@WRAPPER_VERSION@.0">
    <description>Plots the diagonal, and some values close to the diagonal of a HiC matrix</description>
    <macros>
        <token name="@BINARY@">hicPlotTADs</token>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="aggressive">
<![CDATA[
        sed '/^$/d' '$tracks_config' &&
        @BINARY@
            --tracks '$tracks_config'
            #if $region and $region is not None:
                --region '$region'
            #end if
            --outFileName plot.svg

]]>
    </command>
    <configfiles>
        <configfile name="tracks_config">
## lines that start with '#' are comment lines
## and are not interpreted by the program
## the different tracks are represented by sections in this file
## each section starts with a header of the form [hic]
## the content of the section label (in the previous example 'hic') is irrelevant for
## plotting and only used to tell the user when something goes wrong.
## There are two exceptions for this, the [x-axis] and the [spacer] sections
## that use the secion label to determine the action.



#if $x_axis.x_axis_select == "yes":
[x-axis]
#if $x_axis.fontsize:
fontsize = $x_axis.fontsize
#end if
#if $x_axis.where:
where = $x_axis.where
#end if
#else:
[x-axis]
#end if

#for $counter, $track in enumerate($tracks):
[hic_section_$counter]

#if str($track.track_file_style_conditional.track_file_style_selector) == "hic_matrix_option":
#if $track.track_file_style_conditional.track_input_h5:
file = '$track.track_file_style_conditional.track_input_h5'
#end if
#if '$track.track_file_style_conditional.title'
title = '$track.track_file_style_conditional.title'
#end if 
#if $track.track_file_style_conditional.colormap:
colormap = $track.track_file_style_conditional.colormap
#end if
#if $track.track_file_style_conditional.depth:
depth = $track.track_file_style_conditional.depth
#end if
#min_value =2.8
#max_value = 3.0
transform = log1p
boundaries_file = conductance_vs_hic/boundaries_all.bed
x labels = yes
type = arcplot
type = interaction
#optional in case it can not be guessed by the file ending
file_type = hic_matrix
# show masked bins plots as white lines
# those bins that were not used during the correction
# the default is to extend neighboring bins to
# obtain an aesthetically pleasant output
show_masked_bins = yes
# optional if the values in the matrix need to be scaled the
# following parameter can be used
scale factor = 1
[x-axis]
#optional
fontsize=20
# default is bottom meaning below the axis line
where=top


#elif str($track.track_file_style_conditional.track_file_style_selector) == "gene_track_option":
file = genes.bed
title = genes
color = darkblue
#if color is a valid colormap, then the score is mapped
# to the colormap
#color = RdBlGn
width = 5
# to turn off/on printing of labels
labels = off
# optional. If not given is guessed from the file ending
file_type = bed
# optional: font size can be given if default are not good
fontsize = 10
# optional
# display = collapsed
# display = interleaved
#optional, default is black
#border_color = black
# style to plot the genes when they have exon information
#style = UCSC
#style = flybase
# maximum number of gene rows to be plotted. This
# field is useful to limit large number of close genes
# to be printed over many rows. When several images want
# to be combined this must be set to get equal size
# genes in all images
#gene rows = 10
# by default the ymax is the number of
# rows occupied by the genes in the region plotted. However,
# by setting this option, the global maximum is used instead.
# This is useful to combine images that are all consistent and
# have the same number of rows.
#global max row = yes


#elif str($track.track_file_style_conditional.track_file_style_selector) == "peak_track_option":
file = file.bed
title = peaks
color = red
# optional boder color. Set to none for no border color
border_color = black
width = 0.5
# optional. If not given is guessed from the file ending
file_type = bed
#elif str($track.track_file_style_conditional.track_file_style_selector) == "bigwig_track_option":
file = /data/manke/group/ramirez/HiC-ThomasLing/data/external/Graveley_mRNA-seq/GSM390060_Kc167-4_spa.bw
title = Kc RNA-seq (Cherbas et al.)
color = black
min_value = 0
#max_value = auto
width = 1.5
number of bins = 500
nans to zeros = True
# options are: line, points, fill. Default is fill
# to add the preferred line width or point size use:
# type = line:lw where lw (linewidth) is float
# similary points:ms sets the point size (markersize (ms) to the given float
type = line
# type = line:0.5
# type = points:0.5
#optional in case it can not be guessed by the file ending
file_type = bigwig



#elif str($track.track_file_style_conditional.track_file_style_selector) == "chrom_states_option":
# this is a case of a bed file that is plotted 'collapsed'
# useful to plot chromatin states if the bed file contains
# the color to plot
file = chromatinStates.bed
title = chromatin states
# color is replaced by the color in the bed file
# in this case
color = black
# optional boder color. Set to none for no border color
border_color = black
# default behaviour when plotting intervals from a
# bed file is to 'expand' them such that they
# do not overlap. The display = collapsed
# directive overlaps the intervals.
display = collapsed
width = 0.3



#elif str($track.track_file_style_conditional.track_file_style_selector) == "bedgraph_track_option":
file = file.bg
title = bedgraph track
color = green
width = 0.2
# optional, otherwise guseed from file ending
file_type = bedgraph
#elif str($track.track_file_style_conditional.track_file_style_selector) == "bedgraph_matrix_track_option":
file = spectra_conductance.bm
title = conductance spectra
width = 1.5
orientation = inverted
min_value = 0.10
max_value = 0.70
# if type is set as lines, then the TAD score lines are drawn instead
# of the matrix
# set to lines if a heatmap representing the matrix
# is not wanted
type = lines
file_type = bedgraph_matrix
plot horizontal lines=False
#elif str($track.track_file_style_conditional.track_file_style_selector) == "dendogram_track_option":
file =  linkage.bed
title = dendrogram
width = 2
orientation = inverted
# required on this case. Otherwise
# the bed file will be plotted as regions
file_type = dendrogram
# y positions to draw horizontal lines
hlines = 0.2 0.3


#elif str($track.track_file_style_conditional.track_file_style_selector) == "vlines_track_option":
file = regions.bed
type = vlines


#end if









file = $track.track_file_style_conditional.track

#if $track.title
title = $track.track_file_style_conditional.title
#end if

#if $track.colormap and $track.track_input.ext == "h5":
colormap = $track.colormap
#end if

#if $track.color and $track.track_input.ext != "h5":
color = $track.color
#end if

#if $track.border_color:
border_color = $track.border_color
#end if

#if $track.depth:
depth = $track.depth
#end if

#if $track.display:
display = $track.display
#end if

#if $track.width
width = $track.width
#end if

#if $track.min_value:
# auto is possible
min_value = $track.min_value
#end if

#if $track.max_value:
max_value = $track.max_value
#end if

#if $track.transform
transform = $track.transform
#end if

#if $track.boundaries_file:
boundaries_file = $track.boundaries_file
#end if

#if $track.x_labels == 'yes':
x labels = yes
#end if

#if $track.track_input.ext == "bedgraph":
#set $columns = len(open(str($track.track_input)).readline().split('\t'))
#if $columns > 5:
file_type = bedgraph_matrix
#else:
file_type = bedgraph
#end if
#elif $track.track_input.ext == "h5":
file_type = hic_matrix
#else
file_type = $track.track_input.ext
#end if

## show masked bins plots as white lines
## those bins that were not used during the correction
## the default is to extend neighboring bins to
## obtain an aesthetically pleasant output
#if $track.show_masked_bins:
show_masked_bins = $track.show_masked_bins
#end if

#if $track.show_data_range:
show data range = $track.show_data_range
#end if

#if $track.nans_to_zeros:
nans to zeros = $track.nans_to_zeros
#end if

## to turn off/on printing of labels
#if str($track.labels) == 'off'
labels = off
#end if

#if $track.global_max_row == 'yes':
global max row = yes
#end if

## optional: font size can be given if default are not good
#if $track.fontsize:
fontsize = $track.fontsize
#end if

#if $track.number_of_bins:
number of bins = $track.number_of_bins
#end if

#if $track.orientation
orientation = $track.orientation
#end if

#if $track.type
#if $track.track_input.ext == "bigwig":
type = $track.type
#else:
type = $track.type
#end if

#end if

#if $track.gene_rows
gene rows = $track.gene_rows
#end if

#if $track.spacer_width:
[spacer]
width = $track.spacer_width
#end if

#if $track.track_input.ext == "bigwig":
type = $
#end if 


#end for</configfile>
    </configfiles>
    <inputs>
        <expand macro="region" />

        <repeat name="tracks" min="1" title="Include tracks in your plot"
            help="Tracks can be of different filetypes. E.g BED, HiC-Matrix, BigWig or BedGraph">
            <conditional name="track_file_style_conditional">
                <param name="track_file_style_selector" type="select" label="Choose style of the track">
                    <option value="hic_matrix_option">TAD visualization</option>
                    <option value="gene_track_option">Gene track</option>
                    <option value="peak_track_option">Peak track</option>
                    <option value="bigwig_track_option">Big wig track</option>
                    <option value="chrom_states_option">Chromatine states</option>
                    <option value="bedgraph_track_option">Bedgraph track</option>
                    <option value="bedgraph_matrix_track_option">Bedgraph matrix track</option>
                    <option value="dendogram_track_option">Dendogram track</option>
                    <option value="vlines_track_option">Vlines track</option>
                </param>
                <when value="hic_matrix_option">
                    <expand macro="plot_title" />
                    <expand macro="track_input_h5_macro" />
                    
                    <expand macro="colormap" />
                    <param name="depth" type="integer" value="8000000" optional="True" label="Depth" />
                    <param name="min_value" type="float" value="" optional="True" label="Minimum value"/>
                    <param name="max_value" type="float" value="" optional="True" label="Maximum value"/>
                    <param name="transform" type="select" optional="True" label="Plot the transformed value">
                        <option value="log1p">log1p</option>
                        <option value="log">log</option>
                    </param>
                    <param name="type" type="select" optional="True" label="Plotting type">
                        <option value="arcplot">arcplot</option>
                        <option value="interaction">interaction</option>
                    </param>
                    <param name="show_masked_bins" type="boolean" truevalue="yes" falsevalue="no" checked="false"
                            label="Show masked bins" />
                    <param name="boundaries_file" type="data" optional="True" format="bed" label="Boundaries file"/>
                    <param name="scale_factor" type="float" value="1.0" optional="True" label="Scale factor" help="if the values in the matrix need to be scaled the following parameter can be used" />
                    <expand macro="spacer_macro" />
                    <expand macro="fontsize_macro" />
                </when>
                <when value="gene_track_option">
                    <expand macro="plot_title" />
                
                    <expand macro="track_input_bed_macro" />
                    <expand macro="colormap" />
                    <param name="width" type="float" value="1.5" optional="True" label="Width"/>
                    <param name="labels" type="boolean" truevalue="on" falsevalue="off" checked="true"
                            label="Plot labels" />
                    <param name="display" type="select" optional="True" label="Display type">
                        <option value="collapsed">collapsed</option>
                        <!-- <option value="domain">domain</option> -->
                        <option value="interlaced">interlaced</option>
                    </param>
                    <param name="border_color" type="color" value="#000000" label="Border color" optional="True" />
                    <param name="gene_rows" type="integer" value="1" optional="True" label="Gene rows" />
                    
                    <expand macro="spacer_macro" />
                    <expand macro="fontsize_macro" />
                    
                </when>
                <when value="peak_track_option">
                    <expand macro="plot_title" />
                    <param name="color" type="color" value="#000000" label="Color of track" optional="True" />
                    <!-- <expand macro="colormap" /> -->
                    <param name="border_color" type="color" value="#000000" label="Border color" optional="True" />
                    <param name="width" type="float" value="1.5" optional="True" label="Width"/>
                
                    <expand macro="track_input_bed_macro" />
                    <expand macro="spacer_macro" />
                    <expand macro="fontsize_macro" />
                </when>
                <when value="bigwig_track_option">
                    <expand macro="plot_title" />
                
                    <expand macro="track_input_bigwig_macro" />
                    <param name="color" type="color" value="#000000" label="Color of track" optional="True" />
                    
                    <param name="min_value" type="float" value="" optional="True" label="Minimum value"/>
                    <param name="width" type="float" value="1.5" optional="True" label="Width"/>
                    <param name="number_of_bins" type="integer" value="" optional="True" label="Number of bins" />
                    <param name="nans_to_zeros" type="boolean" truevalue="True" falsevalue="False" checked="false"
                            label="NAN's to zeros" />
                    <conditional name="type_conditional">
                         <param name="type_selector" type="select" label="Choose style of the plot.">
                            <option value="fill_option">fill</option>
                            <option value="line_option">line</option>
                            <option value="point_option">point</option>
                        </param>
                    <when value="line_option">
                        <param name="width" type="float" value="0.5" optional="True" label="Width"/>
                    </when>
                    <when value="point_option">
                        <param name="width" type="float" value="0.5" optional="True" label="Width"/>
                    </when>
                    <when value="fill_option" />
                    </conditional>
                    <expand macro="spacer_macro" />
                    <expand macro="fontsize_macro" />
                </when>
                <when value="chrom_states_option">
                    <expand macro="plot_title" />
                
                    <expand macro="track_input_bed_macro" />
                    <param name="color" type="color" value="#000000" label="Color of track" optional="True" />
                    
                    <param name="border_color" type="color" value="#000000" label="Border color" optional="True" />
                    <param name="width" type="float" value="1.5" optional="True" label="Width"/>
                    
                    <expand macro="spacer_macro" />
                    <expand macro="fontsize_macro" />
                    <!-- display = collapsed  -->
                </when>
                <when value="bedgraph_track_option">
                    <expand macro="plot_title" />
                    <expand macro="track_input_bedgraph_macro" />
                    <param name="color" type="color" value="#000000" label="Color of track" optional="True" />
                    
                    <param name="width" type="float" value="1.5" optional="True" label="Width"/>
                    
                    <expand macro="spacer_macro" />
                    <expand macro="fontsize_macro" />
                   
                </when>
                <when value="bedgraph_matrix_track_option">
                    <expand macro="plot_title" />
                
                    <expand macro="track_input_bedgraph_matrix_macro" />
                    <param name="min_value" type="float" value="" optional="True" label="Minimum value"/>
                    <param name="max_value" type="float" value="" optional="True" label="Maximum value"/>

                    <param name="width" type="float" value="1.5" optional="True" label="Width"/>

                     <param name="type_lines" type="boolean" truevalue="lines" falsevalue="" checked="false"
                            label="Set 'type' to 'lines'" help="if type is set as lines, then the TAD score lines are drawn instead
                            of the matrix set to lines if a heatmap representing the matrix is not wanted"/>
                    <!--orientation = inverted  -->
                    <!--plot horizontal lines=False  -->
                    <expand macro="spacer_macro" />
                    <expand macro="fontsize_macro" />
                </when>
                <when value="dendogram_track_option">
                    <expand macro="plot_title" />
                
                    <expand macro="track_input_bed_macro" />
                    <param name="width" type="float" value="1.5" optional="True" label="Width"/>
                    <!--  orientation = inverted -->
                    <!-- file_type = dendrogram  -->
                    <param name="hlines" type="text" value="" label=" y positions to draw horizontal lines" optional="True" />
                    <param name="color" type="color" value="#000000" label="Color of track" optional="True" />
                    
                    <expand macro="spacer_macro" />
                    <expand macro="fontsize_macro" />
                </when>
                <when value="vlines_track_option">
                    <expand macro="track_input_bed_macro" />
                    <!-- type = vlines  -->
                </when>
            </conditional>
           

        </repeat>

        <conditional name="x_axis">
            <param name="x_axis_select" type="select" label="Configure x-axis">
                <option value="no" selected="True">No</option>
                <option value="yes">Yes</option>
            </param>
            <when value="yes">
                <param name="fontsize" type="integer" value="" optional="True" label="Fontsize" />
                <param name="where" type="select" optional="True" label="Where to place the x-axis">
                    <option value="top">Top</option>
                    <option value="bottom">Bottom</option>
                </param>
            </when>
            <when value="no" />
        </conditional>
        <!-- <conditional name="image_file_format_conditional"> -->
            <param name="image_file_format" type="select" label="Image output format">
                    <option value="png">png</option>
                    <option value="svg">svg</option>
            </param>
        <!-- </conditional> -->
            
    </inputs>
    <outputs>
        <data name="outFileName" from_work_dir="plot.svg" format="svg"/>
    </outputs>
    <tests>
        <test>
            <param name="region" value="chrX:3000000-3500000"/>
            <repeat name="tracks">
                <param name="track_input" value="Li_et_al_2015.h5" ftype="h5" />
                <param name="title" value="Kc DpnII (Li et al. 2015)"/>
                <param name="colormap" value="RdYlBu_r"/>
                <param name="depth" value="200000"/>
                <param name="transform" value="log1p"/>
                <param name="boundaries_file" value="domains.bed"/>
                <param name="spacer_width" value="0.5"/>
            </repeat>
            <repeat name="tracks">
                <param name="track_input" value="tad_classification.bed" ftype="bed" />
                <param name="title" value="TAD state"/>
                <param name="width" value="0.5"/>
                <param name="display" value="collapsed"/>
                <param name="labels" value="off"/>
            </repeat>
            <repeat name="tracks">
                <param name="track_input" value="tad_score.gz" ftype="bedgraph" />
                <param name="title" value="TAD separation score (Ramirez et al.)"/>
                <param name="width" value="10"/>
                <param name="type" value="lines"/>
                <param name="spacer_width" value="1"/>
            </repeat>
            <repeat name="tracks">
                <param name="track_input" value="dm3_genes.bed.gz" ftype="bed" />
                <param name="title" value="genes"/>
                <param name="width" value="5"/>
                <param name="fontsize" value="10"/>
                <param name="spacer_width" value="1"/>
            </repeat>
            <repeat name="tracks">
                <param name="track_input" value="dm3_genes.bed.gz" ftype="bed" />
                <param name="title" value="max num rows 3"/>
                <param name="width" value="3"/>
                <param name="fontsize" value="8"/>
                <param name="gene_rows" value="3"/>
                <param name="spacer_width" value="1"/>
            </repeat>
            <repeat name="tracks">
                <param name="track_input" value="dm3_genes.bed6.gz" ftype="bed" />
                <param name="title" value="bed6 global max row"/>
                <param name="width" value="20"/>
                <param name="fontsize" value="10"/>
                <param name="global_max_row" value="True"/>
            </repeat>
            <repeat name="tracks">
                <param name="track_input" value="domains.bed" ftype="bed" />
                <param name="type" value="vlines"/>
            </repeat>
            <output name="outFileName" file="hicPlotTADs_result1.svg" ftype="svg" compare="sim_size" delta="35000"/>
        </test>
    </tests>
    <help><![CDATA[

**What it does**

Plots the diagonal, and some values close to the diagonal of a Hi-C matrix. The diagonal of the matrix is plotted horizontally for a region.

]]></help>
    <expand macro="citations" />
</tool>
